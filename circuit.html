<html>
    <head>
        <title>Circuit</title>
        <style>
            body {
                padding: 0;
                margin: 0;
                background-color: #faead2;
            }

            #container { 
                position: absolute;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%);
            }

            .resistor path {
                transition: 0.5s;
                cursor: pointer;
            }

            .resistor:hover path {
                stroke-width: 4;
            }

            g.edge line {
                transition: 0.5s;
                cursor: pointer;
            }

            g.edge line:hover {
                stroke-width: 5;
            }

            #info {
                font-family: 'Helvetica', 'Arial', sans-serif;
                position: absolute;
                top: 0; left: 0;
                margin: 15px;
                width: 25em;
                color: #940f0f;
                opacity: 0.75;
            }

            #info h1 {
                margin: 0;
                font-weight: bolder;
            }

            #info p {
                width: 15em;
            }
        </style>
    </head>
    <body>
        <div id="info">
            <h1>planar circuit visualizer</h1>
            <p>Play with a maximally planar graph and see what happens when its edgewise biases and resistances are varied!</p>
        </div>
        <div id="container"></div>
    </body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/14.2.1/math.js"></script>
    <script type="module">
        import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

        const width = 1028;
        const height = 1080;
        const N = 40;

        const resistor = (await d3.xml('./circuit/resistor.svg')).children[0];
        resistor.setAttribute('class', 'resistor');
        const resistorH = resistor.height.baseVal.value;
        const resistorW = resistor.width.baseVal.value;

        const svg = d3.create('svg')
            .attr('width', width)
            .attr('height', height)
            .attr('viewBox', [0, 0, width, height])
            .attr('style', 'max-width: 100%; height: auto;');

        let nodes = Array.from({ length: N }, () => ({}));
        let simulation = d3.forceSimulation(nodes)
            .alphaDecay(0.08)
            .force('charge', d3.forceManyBody().strength(-150))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .on('tick', ticked) 
            .on('end', mesh);

        const node = svg.append('g')
            .selectAll('circle')
            .data(nodes)
            .join('circle')
                .attr('r', 4)
                .attr('fill', '#fff')
                .attr('stroke-width', 3)
                .attr('stroke', '#85451e');

        let delaunay = null;
        let incidence = null;
        
        let links = null;
        let link = null;

        function ticked() {
            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);
        }

        function mesh() {
            delaunay = d3.Delaunay.from(nodes, d => d.x, d => d.y);
            incidence = Array.from({ length: N }, () => Array.from({ length: delaunay.halfedges.length }, () => 0));
            links = [];
            
            for (let i = 0; i < delaunay.halfedges.length; i++) {
                let j = delaunay.halfedges[i];
                if (i <= j) continue;
                if (j < 0) j = (j % 3 === 2) ? i - 2 : i + 1;
                const ti = delaunay.triangles[i];
                const tj = delaunay.triangles[j];
                
                incidence[ti][i] = 1;
                incidence[tj][i] = -1;

                links.push({
                    source: nodes[ti],
                    target: nodes[tj],
                    id: links.length
                });
            }

            link = svg.append('g').lower()
                .attr('class', 'edge')
                .attr('stroke', '#940f0f')
                .attr('stroke-opacity', 0.6)
            .selectAll('line')
            .data(links)
            .join('line')
                .attr('stroke-width', d => 2)
                .attr('data-link', d => d.id)
                .on('mouseover', (evt, d) => {
                    document.querySelector(`.resistor[data-link="${d.id}"] path`).style.strokeWidth = 5;
                })
                .on('mouseout', (evt, d) => {
                    document.querySelector(`.resistor[data-link="${d.id}"] path`).style.strokeWidth = '';
                });

            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            svg.append('g')
                .selectAll('.resistor')
                .data(links)
                .enter().append(() => resistor.cloneNode(true))
                .attr('data-link', (d,i) => i)
                .attr('x', d => (d.source.x + d.target.x - resistorW) / 2)
                .attr('y', d => (d.source.y + d.target.y - resistorH) / 2)
                .attr('transform', d => {
                    let angle = Math.atan2(d.target.y - d.source.y, d.target.x - d.source.x) * 180 / Math.PI;
                    let x = (d.source.x + d.target.x) / 2;
                    let y = (d.source.y + d.target.y) / 2;
                    return `rotate(${angle}, ${x}, ${y})`;
                })
                .on('mouseover', (evt, d) => {
                    document.querySelector(`line[data-link="${d.id}"]`).style.strokeWidth = 5;
                })
                .on('mouseout', (evt, d) => {
                    document.querySelector(`line[data-link="${d.id}"]`).style.strokeWidth = '';
                });
        }

        container.append(svg.node());
    </script>
</html>